<!-- app/templates/store/add.html -->
{% import "bootstrap/wtf.html" as wtf %}
{% extends "base.html" %}
{% block title %}Browse{% endblock %}
{% block body %}
<head>
  </head>
  <body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
  <script src="https://cdn.socket.io/3.1.3/socket.io.min.js" integrity="sha384-cPwlPLvBTa3sKAgddT6krw0cJat7egBga3DJepJyrLl4Q9/5WLra3rrnMcyTyOnh" crossorigin="anonymous"></script>
    <script type="text/javascript" charset="utf-8">
    $(document).ready(function(){

    var socket = io.connect('ws://127.0.0.1:5000/');

    window.addEventListener('unload', function(e){
        e.preventDefault()
        e.stopImmediatePropagation();
        e.returnValue = 'unused string';
        e.returnValue = ' ';
        console.log('UNLOAD CONFIRMED. TERMINATING EGG!');
    });

    try{
    var button = document.getElementById("ready")
    button.addEventListener('click', function(e){
        socket.emit('submit', {'data': 'COCK AND BALLS DR.FREEMAN'});
    });
    }
    catch(error){
    /* Do nothing */
    }
    try{
      var button2 = document.getElementById("unready")
      button2.addEventListener('click', function(e){
          socket.emit('unsubmit', {'data': 'COCK AND BALLS DR.FREEMAN'});
    });
    }
    catch(error){
    /* Do nothing */
    }

    socket.on('ready_users', function(data){
        console.log(data)
    });
    
    var ping_pong_times = [];
    var start_time;
    window.setInterval(function() {
        start_time = (new Date).getTime();
        socket.emit('user');
    }, 1000);

    socket.on('my_pong', function(data){
        console.log(data)
        var users_present = data.data.present
        var users_ready = data.data.ready
        console.log(users_present)
        console.log(users_ready)
        
        var latency = (new Date).getTime() - start_time;
        ping_pong_times.push(latency);
        ping_pong_times = ping_pong_times.slice(-30); // keep last 30 samples
        var sum = 0;
        
        for (var i = 0; i < ping_pong_times.length; i++)
            sum += ping_pong_times[i];

        document.getElementById('ping-pong').innerHTML = "";
        for (var i = 0; i < users_present.length; i++)
            $('#ping-pong').append('<br>' + $('<div/>').text(' - ' + users_present[i]).html()); 

        document.getElementById('rdy_users').innerHTML = "";
        for (var i = 0; i < users_ready.length; i++)
            $('#rdy_users').append('<br>' + $('<div/>').text(' - ' + users_ready[i]).html()); 
    });

    socket.on('my_response', function(msg) {
        console.log('EL BOONGER ROONGA', msg.data);
    });
    });

  </script>
  </body>
  <!--<script type="text/javascript" charset="utf-8">
    var socket = io();
    socket.on('connect', function() {
        socket.emit('message', {data:'{{ session["username"] }}'});
    });
</script> -->
  <div class="content-section">
    <div class="center">
      {{ form.csrf_token }}
      <h1>Start Quiz</h1>
      {% if form.start is not defined %}
      <th class="oof" scope="col">{{ wtf.form_field(form.ready)}}</th>
      <th class="oof" scope="col">{{ wtf.form_field(form.unready)}}</th>
      {% endif %}
      {% if form.start is defined %}
      <form method="post" enctype="multipart/form-data">
      {{ form.csrf_token }}
      <th class="oof" scope="col">{{ wtf.form_field(form.start)}}</th>
      </form>
      {% endif %}
      <div class="content-section">
        <h3>Users Connected:</h3>
        <div id="ping-pong"></div>
        <h3>Users Ready:</h3>
        <div id="rdy_users"></div>
      </div>
    </div>
  </div>

{% endblock %}